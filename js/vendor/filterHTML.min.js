var FilterHTML=function(){var t=/^[a-z1-6]$/,e=/^[a-z\-]$/,r=/^[\"'`=<>]$/,i=/^\s$/,s=/^.*&#.*$/,a=/^.*\\[0-9A-Fa-f].*$/,n={url:"#","url|empty":""},l={" ":"%20","%":"%25",">":"%3E","<":"%3C","[":"%5B","]":"%5D","{":"%7B","}":"%7D","|":"%7C","\\":"%5C","^":"%5E"},h=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr","basefont","bgsound","frame","isindex"],o={">":"&gt;","<":"&lt;","&":"&amp;",";":"&semi;"},u={'"':"&quot;",'"':"&apos;"},c=/(\%[0-9a-fA-F]{2})/g,p=/(\&[\#\d\w]+;)/g,f=["aliceblue","antiquewhite","aqua","aquamarine","azure","beige","bisque","black","blanchedalmond","blue","blueviolet","brown","burlywood","cadetblue","chartreuse","chocolate","coral","cornflowerblue","cornsilk","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgray","darkgreen","darkkhaki","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategray","darkturquoise","darkviolet","deeppink","deepskyblue","dimgray","dimgrey","dodgerblue","firebrick","floralwhite","forestgreen","fuchsia","gainsboro","ghostwhite","gold","goldenrod","gray","green","greenyellow","honeydew","hotpink","indianred","indigoivory","khaki","lavender","lavenderblush","lawngreen","lemonchiffon","lightblue","lightcoral","lightcyan","lightgoldenrodyellow","lightgray","lightgreen","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategray","lightsteelblue","lightyellow","lime","limegreen","linen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","mintcream","mistyrose","moccasin","navajowhite","navy","oldlace","olive","olivedrab","orange","orangered","orchid","palegoldenrod","palegreen","paleturquoise","palevioletred","papayawhip","peachpuff","peru","pink","plum","powderblue","purple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","seashell","sienna","silver","skyblue","slateblue","slategray","snow","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","wheat","white","whitesmoke","yellow","yellowgreen"],g=/^#([0-9A-Fa-f]{3}){1,2}$/,_=/^rgb\(\s*\d+%?\s*,\s*\d+%?\s*,\s*\d+%?\s*\)$/,d=/^rgba\(\s*\d+%?\s*,\s*\d+%?\s*,\s*\d+%?\s*,\s*(\d+\.)?\d+\s*\)$/,m=/^hsl\(\s*\d+\s*,\s*\d+%\s*,\s*\d+%\s*\)$/,y=/^hsla\(\s*\d+\s*,\s*\d+%\s*,\s*\d+%\s*,\s*(\d+\.)?\d+\s*\)$/,x=/^(-?\d+(px|cm|pt|em|ex|pc|mm|in)?|\d+%)$/,b=function(t,e,r,i){var s;for(this.html="",this.filtered_html="",this.spec=t,this.global_attrs=t["*"],this.state="data",this.tag_removing=null,this.global_attrs||(this.global_attrs=[]),this.allowed_schemes=e||["http","https","mailto","ftp"],this.text_filter=r||null,i?this.removals=i:(this.removals=[],this.spec.script||this.removals.push("script"),this.spec.style||this.removals.push("style")),this.remove_scripts=!1,s=0;s!==this.removals.length;++s)if("script"===this.removals[s]){this.remove_scripts=!0;break}};b.prototype.filter=function(t){var e,r,i,s,a,n,l;for(this.row=0,this.line=0,this.html=t,this.filtered_html="",this.curr_index=0,this.tag_stack=[],n=!this.remove_scripts,l=this.spec.script&&"string"==typeof this.spec.script,a="";this.next();)"<"===this.curr_char?(i="script-data"!==this.state||l?this.filter_text(a):""+a,s=this.filter_tag(),"script-data-less-than-sign"===this.state?(n&&(a+="<",a+=this.curr_char),this.state="script-data"):(this.filtered_html+=i,a="",this.filtered_html+=s)):("script-data"!==this.state||n)&&("skip-data"===this.state||(a+=this.curr_char));if(this.filtered_html+=this.filter_text(a),0!==this.tag_stack.length){for(e=[],r=0;r!==this.tag_stack.length;++r)e.push(this.tag_stack[r][0]);throw{name:"Tag Mismatch Error",message:"Tags not closed: "+e.join(", ")}}return this.filtered_html},b.prototype.get_tag_spec=function(t){var e=this.spec[t];return"function"==typeof e&&(e=e(t,this.tag_stack)),e||(e=null),e},b.prototype.escape_data=function(t,e){return o[t]?o[t]:e&&u[t]?u[t]:t},b.prototype.filter_text=function(t){var e,r;return e="",this.text_filter?(r=this.text_filter(t,this.tag_stack),e+=r=v(r,this.spec,this.allowed_schemes,null,this.removals)):e+=this.purify_text(t,!1),e},b.prototype.next=function(){return this.curr_char=this.html.charAt(this.curr_index),this.curr_index++,this.row++,"\n"===this.curr_char&&(this.line++,this.row=0),this.curr_char},b.prototype.filter_tag=function(){var t;return t="",this.next(),"/"===this.curr_char?(this.next(),t=this.filter_closing_tag()):"!"===this.curr_char&&"script-data"!==this.state?this.extract_remaining_tag():"script-data"===this.state?this.state="script-data-less-than-sign":t=this.filter_opening_tag(),t},b.prototype.extract_whitespace=function(){var t="";if(i.test(this.curr_char))for(t+=this.curr_char;i.test(this.next());)t+=this.curr_char;return t},b.prototype.extract_tag_name=function(){var e="";if(t.test(this.curr_char.toLowerCase()))for(e+=this.curr_char.toLowerCase();t.test(this.next().toLowerCase());)e+=this.curr_char.toLowerCase();return e},b.prototype.extract_attribute_name=function(){var t="";if(e.test(this.curr_char.toLowerCase()))for(t+=this.curr_char.toLowerCase();e.test(this.next().toLowerCase());)t+=this.curr_char.toLowerCase();return t},b.prototype.extract_remaining_tag=function(){var t="";if(">"!==this.curr_char)for(t+=this.curr_char;">"!==this.next()&&""!==this.curr_char;)t+=this.curr_char;return t},b.prototype.follow_aliases=function(t){var e,r;for(r=[];this.spec[t]&&"string"==typeof this.spec[t];)t=(e=this.spec[t].split(" "))[0],e.length>1&&(r=r.concat(e.slice(1)));return[t,r]},b.prototype.filter_opening_tag=function(){var t,e,r,i,s,a,n,l;if(t="",this.extract_whitespace(),i=this.extract_tag_name(),s=this.get_tag_spec(i),"script"===i)this.state="script-data";else if(!1===s)this.tag_removing=i,this.state="skip-data";else for(e=0;e!==this.removals.length;++e)if(this.removals[e]===i){this.tag_removing=i,this.state="skip-data";break}if(i=(a=this.follow_aliases(i))[0],n=a[1],null!==s&&!1!==s){for(;">"!==this.curr_char&&""!==this.curr_char;)this.extract_whitespace(),(l=this.filter_attribute(i))&&n.push(l);for(t+="<"+i,n.length>0&&(t+=" "+n.join(" ")),t+=">",r=!1,e=0;e!==h.length;++e)if(i===h[e]){r=!0;break}r||this.tag_stack.push([i,n])}else this.extract_remaining_tag();return t},b.prototype.filter_closing_tag=function(){var t,e,r,i,s,a;for(t="",this.extract_whitespace(),i=this.extract_tag_name(),r=!1,e=0;e!==h.length;++e)if(i===h[e]){r=!0;break}if("script"===i&&"script-data"===this.state?this.state="data":i===this.tag_removing&&"skip-data"===this.state&&(this.state="data",this.tag_removing=null),i=this.follow_aliases(i)[0],null!==(s=this.get_tag_spec(i))&&!1!==s&&!r){if(this.extract_whitespace(),">"===this.curr_char){if(t+="</"+i+">",0===this.tag_stack.length)throw{name:"Tag Mismatch Error",message:"Closing tag </"+i+"> not found "+this.line+":"+this.row};if((a=this.tag_stack.pop()[0])!==i)throw{name:"Tag Mismatch Error",message:"Opening tag <"+a+"> does not match closing tag </"+i+"> "+this.line+":"+this.row}}}else this.extract_remaining_tag();return t},b.prototype.filter_attribute=function(t){var r,i,s,a,n,l,h,o;if(a=this.get_tag_spec(t),r=this.extract_attribute_name(),this.extract_whitespace(),n=!!a[r],l=!!this.global_attrs[r],h=!!a["*"],o=!!a["^$"],i=n||l||h||o,s=null,"="===this.curr_char?(this.next(),(s=this.filter_value(t,r))||(i=!1)):e.test(this.curr_char)||">"===this.curr_char?a&&"boolean"===a[r]&&(s=True):(this.next(),i=!1),i){if(!0===s)return r;if(null!==s)return r+"="+s}return null},b.prototype.is_valid_unquoted_attr_char=function(t){return!r.test(t)&&!i.test(t)},b.prototype.filter_value=function(t,e){var r,i,s,a,n,l,h,o;if(i=this.extract_whitespace().length,r="",s='"',"'"===this.curr_char||'"'===this.curr_char){for(s=this.curr_char;this.next()!==s;){if(""===this.curr_char)throw{name:"HTML Syntax Error",message:"Attribute quote not closed: <"+t+" "+e+">"};r+=this.curr_char}this.next()}else if(0===i&&this.is_valid_unquoted_attr_char(this.curr_char))for(r+=this.curr_char;this.is_valid_unquoted_attr_char(this.next());)r+=self.curr_char;return a=null,n=null,null!==(h=this.get_tag_spec(t))&&(h[e]?a=h[e]:h["*"]?a=h["*"]:h["^$"]&&(o=h["^$"].filter(function(t){return t[0]instanceof RegExp&&t[0].test(e)})).length>0&&(a=o[0][1])),this.global_attrs&&this.global_attrs[e]&&(n=this.global_attrs[e]),a||n?(l=null,a&&(l=this.purify_attribute(e,r,a)),n&&null==l&&(l=this.purify_attribute(e,r,n)),null===l?null:!0===l||s+l+s):null},b.prototype.purify_attribute=function(t,e,r){var i,s,a,n,l,h,o,u;if(e=(h=this.purify_value(e,r,t))[0],!h[1])if("class"===t&&"[object Array]"==Object.prototype.toString.call(r)){for(i=e.split(" "),a={},s=[],n=0;n!=i.length;++n)for(l=0;l!=r.length;++l)u=null,r[l]instanceof RegExp?u=this.purify_regex(i[n],r[l]):"function"==typeof r?u=r[l](i[n]):i[n]===r[l]&&(u=i[n]),u&&!a[u]&&(a[u]=!0,s.push(u));e=s.length>0?s.join(" "):null}else if("style"===t&&"[object Object]"==Object.prototype.toString.call(r)){for(i=e.split(";"),s=[],n=0;n!=i.length;++n)""!==(o=this.purify_style(i[n],r))&&null!=o&&s.push(o);e=s.length>0?s.join(";")+";":null}else r.length>0&&r.indexOf(e)<0&&(e=null);return e},b.prototype.purify_value=function(t,e,r){var i=!0;return s.test(t)?t=null:"*"===e?t=t:e instanceof RegExp?t=this.purify_regex(t,e):"boolean"===e?t=""===t||null!==r&&t===r||null:"url"===e?(t=t.trim(),t=this.purify_url(t)):"url|empty"===e?""!==(t=t.trim())&&(t=this.purify_url(t)):"color"===e?t=this.purify_color(t):"measurement"===e?t=this.purify_regex(t,x):"int"===e?t=this.purify_int(t):"alpha"===e?t=""===t?null:this.purify_regex(t,/^[a-zA-Z]+$/):"alphanumeric"===e?t=""===t?null:this.purify_regex(t,/^[a-zA-Z0-9]+$/):"alpha|empty"===e?""!==t&&(t=this.purify_regex(t,/^[a-zA-Z]+$/)):"alphanumeric|empty"===e?""!==t&&(t=this.purify_regex(t,/^[a-zA-Z0-9]+$/)):"text"===e?t=this.purify_text(t,True):"string"==typeof e&&"["===e.charAt(0)&&"]"===e.charAt(e.length-1)?t=""===t?null:this.purify_set(t,e.slice(1,-1)):"function"==typeof e?t=e(t):i=!1,null===t&&n[e]&&(t=n[e]),[t,i]},b.prototype.escape_pattern=function(t,e,r){var i,s,a,n,l;i={},(s=e.match(t))&&s.forEach(function(t){i[t]=!0}),a=[],n=e.split(t);for(var h=0;h<n.length;h++)l=n[h],i[l]||(l=l.split("").map(r).join("")),a.push(l);return a.join("")},b.prototype.purify_style=function(t,e){var r,i,s,n;if(2!==(r=t.split(":")).length)return null;if(i=r[0].trim(),s=r[1].trim(),a.test(s))return null;if(!e[i])return null;if(n=e[i],s=(r=this.purify_value(s,n))[0],r[1]){if(null===s||""===s)return null}else if(n.indexOf(s)<0)return null;return i+":"+s},b.prototype.purify_color=function(t){var e;t=t.toLowerCase();for(e=0;e!==f.length;++e)if(t===f[e])return t;return g.test(t)?t:_.test(t)?t:d.test(t)?t:m.test(t)?t:y.test(t)?t:null},b.prototype.purify_url=function(t){var e,r,i,s;return s=function(t){return l[t]||t},t=this.escape_pattern(c,t,s),this.allowed_schemes.indexOf("//")<0&&"/"===t.charAt(0)&&"/"===t.charAt(1)?null:(r="",(e=t.split(":")).length>1&&((r=e[0]).indexOf("/")>=0||r.indexOf("#")>=0?(r="",t=null):t=e.slice(1).join(":")),i=this.allowed_schemes.indexOf(r.toLowerCase())>=0,""===r?t:i?r+":"+t:null)},b.prototype.purify_int=function(t){var e=parseInt(t);return isNaN(e)?null:""+e},b.prototype.purify_set=function(t,e){var r,i;return i=e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),r=new RegExp("^["+i+"]+$"),this.purify_regex(t,r)},b.prototype.purify_regex=function(t,e){return e.test(t)?t:null},b.prototype.purify_text=function(t,e){var r=this;return this.escape_pattern(p,t,function(t){return r.escape_data(t,e)})};var v=function(t,e,r,i,s){return new b(e,r,i,s).filter(t)};return{filter_html:v}}();"undefined"!=typeof exports&&(exports=FilterHTML),"undefined"!=typeof module&&(module.exports=FilterHTML);